<div class="row event-show--main_box">
  <div class="col-6">
    <div class="event-show--upper_left">
      <div>
        <h3><%= @event.start_time.strftime('%m/%d %H:%M:%S') %> ~ <%= @event.end_time.strftime('%m/%d %H:%M:%S') %></h3>
      </div>
      <div class="event-show--name">
        <h3>予定：<span class="event-show--name_text"><%= @event.name %></span></h3>
      </div>
      <div class="event-show--place">
        <h3>場所：<span class="event-show--place_text"><%= @event.place %></span></h3>
      </div>
      <div class="event-show--detail">
        <h3>詳細：<span class="event-show--detail_text"><%= simple_format(@event.detail) %></span></h3>
      </div>
      <div class="event-show--remarks">
        <h3>備考：<span class="event-show--detail_text"><%= simple_format(@event.remarks) %></span></h3>
      </div>

      <div>
        <div>
          <h3>登録画像</h3>
          <% if @event.images.present? %>
            <% @event.images.each do |image| %>
              <%= attachment_image_tag image, :image, :fill, 160, 160, size:'160x160' %>
              <%= link_to "Destroy", event_image_path(image), method: :delete, class: "btn btn-danger " %>
            <% end %>
          <% else %>
            画像はありません。
          <% end %>
        </div>
        <div>
          <%= form_with(model: @event, local: true) do |f| %>
            <%= f.attachment_field :images_images, multiple: true, placeholder: "追加画像", class: "" %>
            <%= f.submit "Add Image" %>
          <% end %>
        </div>
      </div>

    </div>
  </div>
  <div class="col-6">
    <div class="event-show--upper_right">
      <h4>Map</h4>

      <div>
        <input id="address" type="textbox" value="">
        <input type="button" value="検索" onclick="codeAddress()">
        <%= form_with(model:[@event, @map], html:{class: "event-show--map_form"},local: true) do |f| %>
        <input type="hidden" name="map[address]" id="hidden_address">
        <%= f.label :name, "ピンの名前" %>
        <%= f.text_field :name %>
        <%= f.submit "保存" %>
        <% end %>
      </div>

      <div id="map"></div>

      <div class="event-show--map_index">
        <h5 class="event-show--pin_title">登録したピン</h5>
        <% @maps.each do |map| %>
          <div class="event-show--pin_name"><i class="fas fa-map-marker-alt"></i><%= map.name %></div>
        <% end %>
      </div>
    </div>
  </div>
</div>


<div>
  <%= link_to '編集する', edit_event_path(@event.id), class: 'btn btn-outline-success' %>
  <%= link_to '削除する', event_path(@event.id), method: :delete, class: 'btn btn-outline-danger' %>
</div>




<div>

</div>

<!--以下googleMap情報-->
<script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_API_KEY'] %>&callback=initMap" async defer></script>

<script>
  let map
  let geocoder
  // 変数を追加
  let marker

  function initMap() {
    geocoder = new google.maps.Geocoder()

    // 変数の名前をmapInstanceに変更、デフォルト位置を東京に変更
    mapInstance = new google.maps.Map(document.getElementById('map'), {
      center: {
        <% if @maps.present? %>
          lat: <%= @map_pin.latitude %>,
          lng: <%= @map_pin.longitude %>
        <% else %>
          lat: 35.681,
          lng: 139.767
        <% end %>
      },
      zoom: 13
    });

    // 保存された地図情報からピンをさす
    <% @maps.each do |map| %>
    // google.maps.LatLngインスタンスを生成
    pos = new google.maps.LatLng(
    <%=map.latitude%>, //latitude
    <%=map.longitude%> //longitude
    );
    default_marker = new google.maps.Marker({
    map: mapInstance,
    position: pos,
    icon: {
    url: ' https://maps.google.com/mapfiles/ms/icons/green-dot.png', //アイコンのURL
    scaledSize: new google.maps.Size(40, 40) //サイズ
    }
    });
    <% end %>
  }

  function codeAddress() {
    let inputAddress = document.getElementById('address').value;

    geocoder.geocode({
      'address': inputAddress
    }, function (results, status) {
      if (status == 'OK') {
        // map→mapInstanceに変更
        mapInstance.setCenter(results[0].geometry.location);

        // 既存の検索マーカーを削除
        if(marker != null){
        marker.setMap(null);
        }
        marker = null;

        // var marker → markerへ変更
        marker = new google.maps.Marker({
          //map→mapInstanceに変更
          map: mapInstance,
          position: results[0].geometry.location
        });

        let title = document.getElementById('map_name');
        title.setAttribute("value", inputAddress);

        let hidden_address = document.getElementById('hidden_address');
        hidden_address.setAttribute("value", inputAddress);
      } else {
        alert('Geocode was not successful for the following reason: ' + status);
      }
    });
  }
</script>